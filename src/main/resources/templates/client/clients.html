<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="fragments/headTag :: bootstrap"></div>
    <script th:src="@{/js/cookie.js}"></script>
</head>
<body>

<div th:replace="managernavbar :: managerNavbar"></div>

<div style="margin-top:52px">

    <div class="container" style=" box-shadow: 0 3px 6px 0; border-radius: 10px;
     background: #ffffff; width:950px; ">

        <!--modal window with create calculate-->
        <div th:replace="client/clientFragments/addCalculateFragment :: calculateModal"></div>
        <!-- -->

        <br/>
        <div th:each="calculate : ${listCalculate}">

            <!--head panel -->
            <div class="panel panel-primary">
                <div class="panel-heading" style="height: 44px">
                    <div class="panel-title">
                        <form style="float: left" method="post" action="/manager/refresh-board"
                              th:id="'formRef'+${calculate.id}">
                            <input type="hidden" name="calculateId" th:value="${calculate.id}"/>

                            <select onchange="submit();"
                                    style="width:130px; float: left; height: 34px;font-size:18px;margin-top: -5px;margin-left: -10px "
                                    class="form-control" th:form="'formRef'+${calculate.id}" name="boardId">

                                <p th:each="b : ${listBoard}">

                                <p th:if="(${calculate.getBoard().name} != ${b.name})">
                                    <option th:value="${b.id}" th:text="${b.name}"></option>
                                </p>

                                <p th:if="(${calculate.getBoard().name} == ${b.name})">
                                    <option th:value="${b.id}" th:text="${b.name}" selected=""></option>
                                </p>
                                </p>
                            </select>
                        </form>

                        <!--modal window with create calculate-->
                        <div th:replace="client/clientFragments/addClientFragment :: clientModal"></div>
                        <!-- -->

                        <button th:id="'head1' + ${calculate.id}"
                                th:onclick="'cookiePanel(\'' +'accord'+ ${calculate.id} + '\');'"
                                style="float: left; width: 560px; word-wrap: break-word; font-size: 20px; height: 33px;
                                 text-align: center; background: rgba(255,0,0,0);border: none;margin-top: -5px"
                                data-toggle="collapse" th:href="'#accord' + ${calculate.id}"
                                th:text="${calculate.description}">
                        </button>
                    </div>
                </div>
                <!-- -->

                <!--body panel -->
                <div th:id="'accord' + ${calculate.id}" class="collapse">
                    <script th:inline="javascript">
                        var id = 'accord' + [[${calculate.id}]];
                        if ($.cookie(id) == true.toString()) {
                            $('#' + id).collapse();
                        }
                    </script>


                    <div class="panel-body" style="background: #f6f6f6">
                        <table style="margin-top: -15px;" class="table ">
                            <thead>

                            <tr style="font-size: 17px">
                                <th style="text-align: center;">Карта</th>
                                <th style="text-align: center;">Описание</th>
                                <th style="text-align: center;">Старт</th>
                                <th style="text-align: center;"></th>

                                <th style="text-align: center;">Скидка</th>
                                <th style="text-align: center;"> ₽ с карты</th>
                                <th style="text-align: center;">Сумма</th>
                                <th th:id="${calculate.id}">
                                    <input th:id="'checked' + ${calculate.id}" type="checkbox"
                                           th:onchange="'check(\'' + ${calculate.id} + '\')'"
                                           class="form-control" style="width: 20px;height: 20px"/>
                                </th>

                                <form th:id="'formTest' + ${calculate.id}"
                                      method="post">
                                    <input type="hidden" name="calculateId" th:value="${calculate.id}"/>
                                </form>
                            </tr>

                            </thead>
                            <tbody style="font-size: 20px">
                            <p th:each="client : ${calculate.client}">
                                <tr>


                                    <td>
                                        <!-- Выбор карт-->
                                        <form th:id="'cardSel' + ${client.id}" method="post"
                                              action="/manager/add-card-on-client">
                                            <input type="hidden" name="clientId" th:value="${client.id}"/>
                                            <input type="hidden" name="calculateId" th:value="${calculate.id}"/>
                                            <select th:onchange="'ajaxCardDiscount(\'' + ${client.id} + '\');'"
                                                    class="form-control" name="cardId"
                                                    style="width: 130px; margin: auto; font-size: 17px;font-weight:bold">
                                                <option value="-1"
                                                        th:selected="${client.card} == null ? 'true' : 'false'">Нет
                                                </option>
                            <p th:each="card : ${calculate.cards}">
                                <option th:text="${card.name} + ' ('+${card.balance}+ 'р, ' + ${card.discount} +'% )'"
                                        th:value="${card.id}"
                                        th:selected="(${client.card} == ${card}) ? 'true' : 'false' ">

                                </option>
                            </p>
                            </select>


                            </form>
                            <!-- -->

                            </td>


                            <form th:id="'updateForm' + ${client.id}" method="post">
                                <input type="hidden" name="clientId" th:value="${client.id}"/>

                                <td>
                                    <input autocomplete="off" th:id="'one' + ${client.id}"
                                           th:onblur="'subAjax(\'' + ${client.id} + '\');'" class="form-control"
                                           style="width:150px;margin: auto;font-size: 17px"
                                           name="description" th:value="${client.description}" maxlength="30"/>
                                </td>
                                <td style="text-align: center">
                                    <p th:text="${client.timeStart}"></p></td>
                                <td style="text-align: center">

                                </td>
                                <td>
                                    <p th:id="'dopDiscount' + ${client.id}" style="float: left;"
                                       th:text="${client.discountWithCard} + '% + '"></p>
                                    <select th:id="'two' + ${client.id}" autocomplete="off"
                                            th:onchange="'subAjax(\'' + ${client.id} + '\');'" class="form-control"
                                            name="discount"
                                            style="width: 90px; margin: auto; font-size: 17px;font-weight:bold">
                                        <option value="0" th:selected="${client.discount} == 0 ? 'true' : 'false' ">
                                            Нет
                                        </option>
                                        <option value="15" th:selected="${client.discount} == 15 ? 'true' : 'false' ">
                                            15% &emsp; Пенсионерам/Студентам
                                        </option>
                                        <option value="25" th:selected="${client.discount} == 25 ? 'true' : 'false' ">
                                            25% &emsp; Праздничная
                                        </option>
                                        <option value="35" th:selected="${client.discount} == 35 ? 'true' : 'false' ">
                                            35% &emsp; Админская
                                        </option>
                                    </select>

                                </td>
                                <td>

                                    <input autocomplete="off" th:id="'three' + ${client.id}"
                                           th:onblur="'subAjax(\'' + ${client.id} + '\');'"
                                           class="form-control"
                                           style="width:85px;margin: auto;font-size: 20px"
                                           name="payWithCard" maxlength="7" th:value="${client.payWithCard}"/>
                                </td>
                                <td th:id="'price' + ${client.id}" style="text-align: center">
                                </td>

                            </form>
                            <td>
                                <input th:form="'formTest' + ${calculate.id}" th:class="'class' + ${calculate.id}"
                                       th:id="'test' + ${client.id}" type="checkbox" class="form-control"
                                       style="width: 20px;height: 20px;margin-top: 5px" th:value="${client.id}"
                                       name="clientsId"/>
                            </td>
                            </tr>
                            </p>
                            </tbody>

                        </table>

                        <button style="float: left;margin-left: 700px;" class="btn btn-primary"
                                data-toggle="modal" th:href="'#menuModal' + ${calculate.id}"> Заказ
                        </button>
                        <div th:replace="client/clientFragments/getCheckFragment :: checkModal"></div>
                        <div th:replace="client/clientFragments/menuFragment :: menuModal"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div th:replace="fragments/managerChangePassword :: managerChangePassword"></div>
</div>

<script type="text/javascript">
    ajax();
    setInterval(ajax, 60000);
    function cookiePanel(id) {
        if ($.cookie(id) == true.toString()) {
            $.cookie(id, "false");
        } else if ($.cookie(id) == false.toString() || $.cookie(id) == null) {
            $.cookie(id, "true");
        }
    }

    function ajaxCardDiscount(id) {

        $.ajax({
            type: "POST",
            url: "/manager/add-card-on-client",
            data: $('#cardSel' + id).serialize(),

            success: function (data) {
                //<![CDATA[
                $('#dopDiscount' + id).html(data + '%' + ' + ');
                setTimeout(ajax, 1000);
                //]]>
            },
            error: function () {
                console.log('ajaxCardDiscount сломался? ');
            }
        });
    }

    function ajaxModal(id) {

        $.ajax({
            type: "POST",
            url: "/manager/output-clients",
            data: $('#formTest' + id).serialize(),

            success: function (data) {
                //<![CDATA[
                if (data == "") {
                    $('#tb' + id).html(" ");
                } else {
                    var allpr = 0;
                    var payWithCard = 0;
                    var str = "";

                    for (var i = 0; i < data.length; i++) {
                        var hours = +data[i].passedTime.hour < 10 ? ('0' + data[i].passedTime.hour) : data[i].passedTime.hour;
                        var min = +data[i].passedTime.minute < 10 ? ('0' + data[i].passedTime.minute) : data[i].passedTime.minute;
                        var time = hours + ':' + min;
                        var order = "";

                        str += '<tr><td class="cent">' + ((data[i].card == null) ? 'Нет' : data[i].card.name) + '</td><td class="cent">' + data[i].description + '</td><td class="cent">' + time + '</td><td class="cent">' + data[i].priceTime + '</td><td class="cent"><div  class="dropdown"><button onclick="getLayerProductAjax(' + data[i].id + ')"   class="btn btn-primary" data-toggle="dropdown" style="width: 100px;font-size: 20px;height:30px;margin-right: 5px;margin-top: 5px;padding: 0px">' + data[i].priceMenu + 'р' + '</button><div id = "clientDropMenu' + data[i].id + '"  style="width: 250px;font-size: 20px" class="dropdown-menu dropdown-menu-right">' + order + '</div></div></div> </td><td class="cent">' + ((+data[i].discount) + (+data[i].discountWithCard)) + '</td><td class="cent">' + data[i].payWithCard + '</td><td class="cent">' + data[i].cache + '</td></tr>';

                        payWithCard += data[i].payWithCard;
                        allpr += data[i].cache;
                    }
                    $('#head' + id).html($('#head1' + id).text())
                    $('#all' + id).html(payWithCard + 'р<br/>' + allpr + 'р');
                    $('#tb' + id).html(str);
                }
                //]]>
            },
            error: function () {
                console.log('ajaxModal сломался? ');
            }
        });
    }

    function getLayerProductAjax(clientId) {
        $.ajax({
            type: "POST",
            url: "/manager/get-layer-products-on-client",
            data: {clientId: clientId},

            success: function (data) {
                //<![CDATA[
                var str = " ";
                for (var i = 0; i < data.length; i++) {
                    str += '<li>' + data[i].name + ' №' + data[i].id + ' (' + data[i].cost + 'р)' + '</li>';
                }
                $('#clientDropMenu' + clientId).html(str);
                //]]>
            },
            error: function () {
                console.log('getLayerProductAjax сломался? ');
            }
        });
    }


    function ajax() {
        $.ajax({
            type: "POST",
            url: "/manager/calculate-price",
            success: function (data) {
                //<![CDATA[
                for (var i = 0; i < data.length; i++) {
                    $('#price' + data[i].id).html(data[i].allPrice);
                }

                //]]>
            },
            error: function () {
                console.log('ajax сломался? ');
            }
        });
    }

    function check(id) {
        if ($('#checked' + id).is(':checked')) {
            $(".class" + id).prop("checked", true);
        } else {
            $(".class" + id).prop("checked", false);
        }
    }

    function check1(id) {
        if ($('#checked1' + id).is(':checked')) {
            $(".class1" + id).prop("checked", true);
        } else {
            $(".class1" + id).prop("checked", false);
        }
    }

    function subAjax(id) {
        $.ajax({
            type: "POST",
            url: "/manager/update-fields-client",
            data: $('#updateForm' + id).serialize(),
            success: function (data) {
                //<![CDATA[
                $('#clientMenuDescription' + id).text(data);
                setTimeout(ajax, 1000);
                //]]>
            },
            error: function () {
                console.log('subAjax сломался? ');
            }
        });
    }

    function createLayerProductAjax(prodId, calcId) {
        $('#productId' + calcId).val(prodId);
        $.ajax({
            type: "POST",
            url: "/manager/create-layer-product",
            data: $('#addProductOnClientForm' + calcId).serialize(),
            success: function (data) {
                //<![CDATA[
                var arr = data.clients;
                for (var i = 0; i < arr.length; i++) {
                    $('#ajaxMenu' + arr[i].id + ' li:last').after('<li id = "pr' + data.id + '">' + data.name + ' №' + data.id + ' (' + data.cost + 'р)' + '</li>');
                }
                setTimeout(getOpenClientsOnCalculateAjax(calcId), 500);
                setTimeout(ajax, 500);
                //]]>
            },
            error: function () {
                console.log('createLayerProductAjax сломался? ');
            }
        });
    }


    function addLayerProductOnClientAjax(layerProdId, calcId) {
        $('#productId' + calcId).val(layerProdId);
        $.ajax({
            type: "POST",
            url: "/manager/add-client-on-layer-product",
            data: $('#addProductOnClientForm' + calcId).serialize(),
            success: function (data) {
                //<![CDATA[
                var arr = data.clients;
                for (var i = 0; i < arr.length; i++) {
                    if (document.getElementById('ajaxMenu' + arr[i].id).querySelector("#pr" + data.id) == null) {
                        $('#ajaxMenu' + arr[i].id + ' li:last').after('<li id = "pr' + data.id + '">' + data.name + ' №' + data.id + ' (' + data.cost + 'р)' + '</li>');
                    }
                }
                setTimeout(getOpenClientsOnCalculateAjax(calcId), 500);
                setTimeout(ajax, 500);
                //]]>
            },
            error: function () {
                console.log('addLayerProductOnClientAjax сломался? ');
            }
        });
    }

    function deleteLayerProductOnClientAjax(layerProdId, calcId) {
        $('#productId' + calcId).val(layerProdId);
        $.ajax({
            type: "POST",
            url: "/manager/delete-product-with-client",
            data: $('#addProductOnClientForm' + calcId).serialize(),
            success: function (data) {
                //<![CDATA[
                var arr = data.clients;
                for (var i = 0; i < arr.length; i++) {
                    var v = document.getElementById('ajaxMenu' + arr[i].id).querySelector("#pr" + data.id);
                    if (v != null) {
                        v.remove();
                    }
                }
                getProductOnCalculateAjax(calcId);
                setTimeout(getOpenClientsOnCalculateAjax(calcId), 500);
                setTimeout(ajax, 500);
                //]]>
            },
            error: function () {
                console.log('deleteLayerProductOnClientAjax сломался? ');
            }
        });
    }


    function getProductOnCalculateAjax(calcId) {
        $.ajax({
            type: "POST",
            url: "/manager/get-products-on-calculate",
            data: {calculateId: calcId},
            success: function (data) {
                //<![CDATA[
                var str;
                if (data != "") {
                    for (var i = 0; i < data.length; i++) {
                        str += '<tr style="font-size: 20px;"><td>' + data[i].name + ' №' + data[i].id + '</td><td>' + data[i].description + '</td><td>' + data[i].cost + '</td><td><button onclick="addLayerProductOnClientAjax(' + data[i].id + ',' + calcId + ')" style="background:rgba(255,0,0,0);float: left;margin-left: 20px; border: none;"> <i class="fa fa-check" aria-hidden="true" style="font-size: 30px;color:#910405;"></i></button><button onclick="deleteLayerProductOnClientAjax(' + data[i].id + ',' + calcId + ')" style="background:rgba(255,0,0,0);float: left;margin-left: 20px; border: none;"><i class="fa fa-times" aria-hidden="true" style="font-size: 30px;color:#910405;"></i></button></td></tr>';
                    }
                } else {
                    str = null;
                }

                $("#prodOnCalculate" + calcId).html(str);
                //]]>
            },
            error: function () {
                console.log('getProductOnCalculateAjax сломался? ');
            }
        });
    }

    function getOpenClientsOnCalculateAjax(calcId) {
        $.ajax({
            type: "POST",
            url: "/manager/get-open-clients-on-calculate",
            data: {calculateId: calcId},
            success: function (data) {
                //<![CDATA[
                for (var i = 0; i < data.length; i++) {
                    $('#priceMenu' + data[i].id).html(data[i].priceMenu);
                }
                //]]>
            },
            error: function () {
                console.log('getOpenClients сломался? ');
            }
        });
    }
    //2 снизу это скрипты поиска по продуктам/категориям
    $(document).ready(function () {
        $("#search").keyup(function () {
            _this = this;

            $.each($("#mycateg a"), function () {
                if ($(this).text().toLowerCase().indexOf($(_this).val().toLowerCase()) === -1) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    });

    $(document).ready(function () {
        $("#searchPr").keyup(function () {
            _this = this;

            $.each($(".mytable tbody tr"), function () {
                if ($(this).text().toLowerCase().indexOf($(_this).val().toLowerCase()) === -1) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    });
</script>

</body>
</html>